<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能题库助手</title>
  <meta http-equiv="Cache-Control" content="max-age=31536000, immutable">
  <script src="https://cdn.tailwindcss.com?v=1.0"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.5.13/vue.global.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/pinyin-pro/3.26.0/index.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap&v=1.0');

    body {
      font-family: 'Inter', sans-serif;
    }

    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 2px;
      height: 2px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
    }

    /* 自定义滚动条类 */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    /* 渐变背景 */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card-gradient {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(10px);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    /* 自定义动画 */
    .bounce-in {
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }

      50% {
        transform: scale(1.05);
      }

      70% {
        transform: scale(0.9);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .slide-up {
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      0% {
        transform: translateY(20px);
        opacity: 0;
      }

      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* 悬停效果 */
    .hover-rise:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .hover-glow:hover {
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    /* 自定义按钮样式 */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* 圆形进度条 */
    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-circle {
      transition: stroke-dasharray 0.3s ease;
    }

    /* 输入框聚焦效果 */
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      border-color: #667eea;
    }

    /* 通知组件样式 */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      width: 300px;
      max-width: 90vw;
    }

    .notification {
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      position: relative;
      overflow: hidden;
      background-color: white;
    }

    .notification-info {
      border-left: 4px solid #3b82f6;
    }

    .notification-success {
      border-left: 4px solid #22c55e;
    }

    .notification-warning {
      border-left: 4px solid #f59e0b;
    }

    .notification-error {
      border-left: 4px solid #ef4444;
    }

    .notification-confirm {
      border-left: 4px solid #8b5cf6;
    }

    .notification-icon {
      margin-right: 12px;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .notification-message {
      font-size: 13px;
      color: #4b5563;
    }

    .notification-close {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px;
      cursor: pointer;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .notification-close:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .notification-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
      gap: 8px;
    }

    .notification-button {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .notification-button-primary {
      background-color: #3b82f6;
      color: white;
    }

    .notification-button-primary:hover {
      background-color: #2563eb;
    }

    .notification-button-secondary {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    .notification-button-secondary:hover {
      background-color: #d1d5db;
    }

    .notification-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background-color: rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .notification-progress-bar {
      height: 100%;
      width: 100%;
      transform-origin: left;
      animation: progress 5s linear forwards;
    }

    .notification-enter-active,
    .notification-leave-active {
      transition: all 0.3s ease;
    }

    .notification-enter-from {
      transform: translateX(100%);
      opacity: 0;
    }

    .notification-leave-to {
      transform: translateX(100%);
      opacity: 0;
    }

    @keyframes progress {
      from {
        transform: scaleX(1);
      }

      to {
        transform: scaleX(0);
      }
    }

    /* 开关按钮样式 */
    .toggle-bg {
      transition: background-color 0.3s ease;
    }

    .toggle-dot {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    input:checked+.toggle-bg+.toggle-dot {
      box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
    }

    input:focus+.toggle-bg {
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    input:hover+.toggle-bg {
      background-color: #e5e7eb;
    }

    input:checked:hover+.toggle-bg {
      background-color: #3b82f6;
    }

    /* 红色开关样式 */
    input:checked+.toggle-bg.bg-red-500+.toggle-dot {
      box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
    }

    input:focus+.toggle-bg.bg-red-500 {
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    input:checked:hover+.toggle-bg.bg-red-500 {
      background-color: #ef4444;
    }

    /* 分隔线 */
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(209, 213, 219, 0.5), transparent);
      margin: 16px 0;
    }
  </style>
</head>

<body class="bg-gray-100 w-full h-screen overflow-hidden">
  <div id="app" class="h-full flex flex-col overflow-hidden">
    <!-- 顶部装饰条 -->
    <div class="gradient-bg h-1"></div>

    <!-- 通知组件 -->
    <div class="notification-container">
      <transition-group name="notification">
        <div v-for="notification in notifications" :key="notification.id"
          :class="['notification', `notification-${notification.type}`]">
          <div class="notification-icon">
            <i v-if="notification.type === 'info'" data-lucide="info" class="w-5 h-5 text-blue-500"></i>
            <i v-else-if="notification.type === 'success'" data-lucide="check-circle"
              class="w-5 h-5 text-green-500"></i>
            <i v-else-if="notification.type === 'warning'" data-lucide="alert-triangle"
              class="w-5 h-5 text-amber-500"></i>
            <i v-else-if="notification.type === 'error'" data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>
            <i v-else-if="notification.type === 'confirm'" data-lucide="help-circle"
              class="w-5 h-5 text-purple-500"></i>
          </div>
          <div class="notification-content">
            <div v-if="notification.title" class="notification-title">{{ notification.title }}</div>
            <div class="notification-message">{{ notification.message }}</div>
            <div v-if="notification.type === 'confirm'" class="notification-actions">
              <button @click="notification.onCancel(); removeNotification(notification.id)"
                class="notification-button notification-button-secondary">
                取消
              </button>
              <button @click="notification.onConfirm(); removeNotification(notification.id)"
                class="notification-button notification-button-primary">
                确认
              </button>
            </div>
          </div>
          <div class="notification-close" @click="removeNotification(notification.id)">
            <i data-lucide="x" class="w-4 h-4 text-gray-400"></i>
          </div>
          <div v-if="notification.autoClose" class="notification-progress">
            <div class="notification-progress-bar" :style="{ 'background-color': getProgressColor(notification.type) }">
            </div>
          </div>
        </div>
      </transition-group>
    </div>

    <!-- 主要内容区域 -->
    <div class="flex-1 w-full h-full overflow-hidden">
      <!-- 科目管理页面 -->
      <div v-show="currentTab === 'subjects'"
        class="h-full flex flex-col bg-gradient-to-br from-purple-50 to-blue-50 overflow-hidden">
        <!-- 可滚动内容区域 -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <!-- 标题部分（可滚动） -->
          <div class="gradient-bg px-6 pt-8 pb-6">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold text-white mb-1">学科中心</h1>
                <p class="text-purple-100 text-sm">管理您的学习科目</p>
              </div>
              <div class="bg-white/20 rounded-full p-3">
                <i data-lucide="book-open" class="w-6 h-6 text-white"></i>
              </div>
            </div>
          </div>

          <!-- 科目统计卡片 -->
          <div class="px-6 -mt-6 mb-6">
            <div class="glass-effect rounded-2xl p-4">
              <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-gray-800">{{ subjects.length }}</div>
                  <div class="text-xs text-gray-600">科目总数</div>
                </div>
                <div class="text-center border-l border-r border-white/30">
                  <div class="text-2xl font-bold text-gray-800">{{ questions.length }}</div>
                  <div class="text-xs text-gray-600">题目总数</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-gray-800">{{ todayQuestions }}</div>
                  <div class="text-xs text-gray-600">今日新增</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 固定在顶部的操作区域 -->
          <div
            class="sticky top-0 z-10 bg-gradient-to-br from-purple-50/95 to-blue-50/95 backdrop-blur-sm border-b border-blue-100/50 shadow-sm">
            <div class="px-6 py-4">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">我的科目</h2>
                <div class="flex flex-wrap gap-2 justify-end">
                  <button @click="exportData"
                    class="bg-blue-500 text-white px-3 py-2 rounded-xl text-sm font-medium hover:bg-blue-600 transition-all flex items-center">
                    <i data-lucide="download" class="w-4 h-4 mr-1"></i>
                    导出
                  </button>
                  <button @click="showImportModal = true"
                    class="bg-green-500 text-white px-3 py-2 rounded-xl text-sm font-medium hover:bg-green-600 transition-all flex items-center">
                    <i data-lucide="upload" class="w-4 h-4 mr-1"></i>
                    导入
                  </button>
                  <button @click="showAddSubjectModal = true"
                    class="btn-primary text-white px-3 py-2 rounded-xl text-sm font-medium hover-glow flex items-center">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                    添加
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 科目列表或空状态 -->
          <div class="px-6 pb-20 pt-4">
            <div v-if="subjects.length > 0" class="space-y-3">
              <div v-for="subject in subjects" :key="subject"
                class="bg-white rounded-2xl shadow-sm hover-rise transition-all duration-300 cursor-pointer"
                @click="selectSubject(subject)">
                <div class="p-5">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 min-w-0">
                      <div class="gradient-bg w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0">
                        <i data-lucide="book" class="w-6 h-6 text-white"></i>
                      </div>
                      <div class="min-w-0">
                        <h3 class="font-semibold text-gray-800 truncate">{{ subject }}</h3>
                        <p class="text-sm text-gray-500">{{ getSubjectQuestionCount(subject) }} 道题目</p>
                      </div>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0">
                      <button @click.stop="confirmDeleteSubject(subject)"
                        class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                      <button @click.stop="showTransferModal(subject)"
                        class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors">
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                      </button>
                      <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="text-center py-16">
              <div class="gradient-bg w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="book-open" class="w-10 h-10 text-white"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">开始您的学习之旅</h3>
              <p class="text-gray-500 mb-8 max-w-sm mx-auto">添加您的第一个学科，开始构建专属题库</p>
              <div class="flex flex-wrap justify-center gap-4">
                <button @click="showAddSubjectModal = true"
                  class="btn-primary text-white px-8 py-4 rounded-2xl text-lg font-medium hover-glow bounce-in">
                  <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                  创建科目
                </button>
                <button @click="showImportModal = true"
                  class="bg-green-500 text-white px-8 py-4 rounded-2xl text-lg font-medium hover:bg-green-600 transition-all bounce-in">
                  <i data-lucide="upload" class="w-5 h-5 inline mr-2"></i>
                  导入数据
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 题目浏览页面 -->
      <div v-show="currentTab === 'questions'"
        class="h-full flex flex-col bg-gradient-to-br from-blue-50 to-indigo-50 overflow-hidden">
        <!-- 题目列表容器，使用overflow-auto使其可滚动 -->
        <div class="flex-1 overflow-auto relative" ref="questionListContainer">
          <!-- 标题部分（可滚动） -->
          <div class="gradient-bg px-6 pt-8 pb-6">
            <div class="mb-4">
              <h1 class="text-2xl font-bold text-white mb-1">题库浏览</h1>
              <p class="text-purple-100 text-sm">探索您的知识宝库</p>
            </div>
            <!-- 添加按钮组 -->
            <div class="flex items-center space-x-2 absolute top-8 right-6">
              <button @click="showAddQuestionModal = true"
                class="bg-white/20 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-white/30 transition-all flex items-center">
                <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                添加题目
              </button>
              <button @click="showConfigModal = true"
                class="bg-white/20 text-white p-2 rounded-xl hover:bg-white/30 transition-all">
                <i data-lucide="settings" class="w-5 h-5"></i>
              </button>
            </div>
          </div>

          <!-- 固定部分容器 -->
          <div class="sticky top-0 z-10 ">
            <!-- 搜索框 -->
            <div class="gradient-bg px-6 pb-6">
              <div class="relative pt-2">
                <input v-model="searchQuery" type="text" placeholder="搜索题目内容、答案..."
                  class="w-full bg-white/20 border border-white/30 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-purple-200 input-glow">
                <i data-lucide="search"
                  class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-purple-200"></i>
                <button v-if="searchQuery" @click="searchQuery = ''"
                  class="absolute right-4 top-1/2 transform -translate-y-1/2 p-1 rounded-full hover:bg-white/20">
                  <i data-lucide="x" class="w-4 h-4 text-purple-200"></i>
                </button>
                <!-- <div class="text-xs text-purple-200 mt-2 ml-1">支持拼音首字母搜索，如"zmkh"可匹配"智能课堂"</div> -->
              </div>
            </div>

            <!-- 筛选器 -->
            <div class="px-6 -mt-4 mb-6">
              <div class="glass-effect rounded-2xl p-4">
                <!-- 筛选器内容区域，使用flex和overflow-x-auto实现横向滑动 -->
                <div class="flex items-center space-x-3 overflow-x-auto pb-2">
                  <!-- 科目筛选 -->
                  <div v-if="selectedSubjectFilter" class="flex-shrink-0">
                    <div
                      class="inline-flex items-center bg-blue-100 text-blue-800 px-3 py-2 rounded-full text-sm whitespace-nowrap">
                      <i data-lucide="book" class="w-3 h-3 mr-1"></i>
                      {{ selectedSubjectFilter }}
                      <button @click="clearSubjectFilter" class="ml-2 hover:bg-blue-200 rounded-full p-0.5">
                        <i data-lucide="x" class="w-3 h-3"></i>
                      </button>
                    </div>
                  </div>

                  <!-- 分类筛选 -->
                  <button @click="selectedCategory = ''" :class="[
                    'px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all flex-shrink-0',
                    selectedCategory === '' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  ]">
                    全部分类
                  </button>
                  <button v-for="category in categories" :key="category" @click="selectedCategory = category" :class="[
                    'px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all flex-shrink-0',
                    selectedCategory === category ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  ]">
                    {{ category }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 题目列表 -->
          <div class="w-full px-6 pb-20">
            <div v-if="pagedQuestions.length > 0" class="space-y-4">
              <div v-for="(question, index) in pagedQuestions" :key="index"
                class="bg-white rounded-2xl shadow-sm hover-rise transition-all duration-300">
                <div class="p-6">
                  <!-- 题目标签 -->
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                      <span v-if="!selectedCategory"
                        class="bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 px-3 py-1 rounded-full text-xs font-medium">
                        {{ question.classification }}
                      </span>
                      <span v-if="!selectedSubjectFilter" class="text-xs text-gray-500">
                        {{ question.subjects_name }}
                      </span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <div class="text-xs text-gray-400">#{{ index + 1 }}</div>
                      <button @click="confirmDeleteQuestion(question)"
                        class="p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>

                  <!-- 题目内容 -->
                  <div class="mb-4">
                    <p class="text-gray-800 leading-relaxed" :style="{ fontSize: `${fontSize}px` }">
                      {{ question.title }}
                    </p>
                  </div>

                  <!-- 答案 -->
                  <div class="border-t border-gray-100 pt-4">
                    <div class="w-full flex items-start space-x-3">
                      <div class="bg-green-100 rounded-lg p-2 flex-shrink-0">
                        <i data-lucide="lightbulb" class="w-4 h-4 text-green-600"></i>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="text-xs text-green-600 font-medium mb-1">答案解析</div>
                        <div class="flex items-center space-x-2">
                          <div class="flex-1 min-w-0">
                            <p class="text-green-700 font-medium truncate"
                              :style="{ fontSize: `${Math.max(12, fontSize * 0.9)}px` }">
                              {{ question.answer }}
                            </p>
                          </div>
                          <button @click="showQuestionDetail(question)"
                            class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs hover:bg-blue-200 transition-colors flex-shrink-0">
                            查看详情
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- 加载更多/全部加载完毕提示区域 -->
              <div class="text-center py-4 text-gray-400 text-sm select-none">
                <template v-if="isLoadingMore">正在加载更多...</template>
                <template v-else-if="isAllLoaded && pagedQuestions.length > 0">已全部加载完毕</template>
              </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="text-center py-16">
              <div
                class="bg-gradient-to-br from-gray-200 to-gray-300 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="search" class="w-10 h-10 text-gray-500"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">
                {{ searchQuery || selectedCategory ? '未找到相关题目' : '还没有题目' }}
              </h3>
              <p class="text-gray-500 mb-8">
                {{ searchQuery || selectedCategory ? '尝试调整搜索条件' : '去上传一些题目开始学习吧' }}
              </p>
            </div>
          </div>
        </div>

        <!-- 字体大小控制，保持固定在底部 -->
        <div class="fixed bottom-20 left-4 right-4 bg-white rounded-2xl shadow-lg p-4 border">
          <div class="flex items-center space-x-4">
            <i data-lucide="type" class="w-5 h-5 text-gray-600"></i>
            <div class="flex-1">
              <input v-model="fontSize" type="range" min="8" max="48" step="1"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <span class="text-sm text-gray-600 font-medium min-w-[40px]">{{ fontSize }}px</span>
          </div>
        </div>
      </div>

      <!-- 上传页面 -->
      <div v-show="currentTab === 'upload'" class="h-full flex flex-col bg-gradient-to-br from-green-50 to-teal-50">
        <!-- 头部 -->
        <div class="gradient-bg px-6 pt-8 pb-6">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-white mb-1">智能识别</h1>
              <p class="text-purple-100 text-sm">上传图片或输入文本，AI 帮您整理</p>
            </div>
            <div class="bg-white/20 rounded-full p-3">
              <i data-lucide="upload" class="w-6 h-6 text-white"></i>
            </div>
          </div>
        </div>

        <div class="flex-1 w-full h-full overflow-y-auto p-6 space-y-6">
          <!-- 科目选择 -->
          <div class="bg-white rounded-2xl p-6 shadow-sm slide-up">
            <div class="flex items-center mb-4">
              <div class="bg-blue-100 rounded-lg p-2 mr-3">
                <i data-lucide="folder" class="w-5 h-5 text-blue-600"></i>
              </div>
              <h3 class="font-semibold text-gray-800">选择科目 （暂存）</h3>
            </div>
            <select v-model="selectedSubjectForUpload" class="w-full p-4 border border-gray-200 rounded-xl input-glow">
              <option value="">请选择要上传的科目</option>
              <option v-for="subject in subjects" :key="subject" :value="subject">{{ subject }}</option>
            </select>
          </div>

          <!-- 模型选择 -->
          <div class="bg-white rounded-2xl p-6 shadow-sm slide-up">
            <div class="flex items-center mb-4">
              <div class="bg-purple-100 rounded-lg p-2 mr-3">
                <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-600"></i>
              </div>
              <h3 class="font-semibold text-gray-800">选择AI模型</h3>
            </div>
            <select v-model="selectedModel" class="w-full p-4 border border-gray-200 rounded-xl input-glow">
              <option value="doubao">豆包 (默认)</option>
              <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
              <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-flash-deepsearch">Gemini 2.5 Flash DeepSearch</option>
              <option value="o3">ChatGPT O3</option>
              <option value="o3-mini">ChatGPT O3 mini</option>
              <option value="grok-3">Grok 3</option>
            </select>
            <p class="text-xs text-gray-500 mt-2">不同模型可能有不同的识别效果和速度</p>
          </div>

          <!-- 上传方式选择 -->
          <div class="bg-white rounded-2xl p-6 shadow-sm slide-up">
            <!-- 图片上传区域 -->
            <div v-if="false">
              <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
              <div v-if="!uploadedImage" @click="$refs.fileInput.click()"
                class="border-2 border-dashed border-gray-300 rounded-2xl p-12 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all mb-4">
                <i data-lucide="cloud-upload" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                <h4 class="text-lg font-medium text-gray-800 mb-2">点击上传图片</h4>
                <p class="text-gray-500">支持 JPG、PNG 格式，最大 10MB</p>
              </div>
              <div v-else class="relative mb-4">
                <img :src="uploadedImage" alt="上传的图片" class="w-full rounded-2xl shadow-lg">
                <button @click="clearUploadedImage"
                  class="absolute top-4 right-4 bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-red-600 shadow-lg">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
            </div>

            <!-- 文本输入区域 -->
            <div>
              <textarea v-model="textInput" placeholder="请输入题目内容和答案，AI 将自动为您分析整理..."
                class="w-full h-80 p-4 border border-gray-200 rounded-xl resize-none input-glow"></textarea>
            </div>
          </div>

          <!-- 提交按钮 -->
          <div class="flex space-x-3 mt-6">
            <button @click="processLocalText" :disabled="!textInput || !selectedSubjectForUpload"
              class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-4 rounded-2xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover-glow transition-all">
              <div class="flex items-center justify-center">
                <i data-lucide="code" class="w-5 h-5 mr-2"></i>
                本地解析
              </div>
            </button>
            <button @click="processUpload"
              :disabled="(!uploadedImage && !textInput) || !selectedSubjectForUpload || isProcessing"
              class="flex-1 bg-gradient-to-r from-green-500 to-teal-500 text-white py-4 rounded-2xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover-glow transition-all">
              <div v-if="isProcessing" class="flex items-center justify-center">
                <svg class="animate-spin w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
                AI 正在分析处理中...
              </div>
              <div v-else class="flex items-center justify-center">
                <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                开始 AI 识别
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bg-white/95 backdrop-blur-lg border-t border-gray-200/50 shadow-lg">
      <div class="flex">
        <button @click="currentTab = 'subjects'" :class="[
          'flex-1 py-4 px-4 text-center transition-all relative',
          currentTab === 'subjects' ? 'text-purple-600' : 'text-gray-500'
        ]">
          <div v-if="currentTab === 'subjects'"
            class="absolute top-0 left-1/2 transform -translate-x-1/2 w-8 h-1 bg-gradient-to-r from-purple-500 to-blue-500 rounded-b-full">
          </div>
          <div class="flex flex-col items-center space-y-1">
            <div :class="[
              'w-10 h-10 rounded-xl flex items-center justify-center transition-all',
              currentTab === 'subjects' ? 'bg-purple-100' : 'bg-transparent'
            ]">
              <i data-lucide="book-open" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">科目</span>
          </div>
        </button>

        <button @click="currentTab = 'questions'" :class="[
          'flex-1 py-4 px-4 text-center transition-all relative',
          currentTab === 'questions' ? 'text-purple-600' : 'text-gray-500'
        ]">
          <div v-if="currentTab === 'questions'"
            class="absolute top-0 left-1/2 transform -translate-x-1/2 w-8 h-1 bg-gradient-to-r from-purple-500 to-blue-500 rounded-b-full">
          </div>
          <div class="flex flex-col items-center space-y-1">
            <div :class="[
              'w-10 h-10 rounded-xl flex items-center justify-center transition-all',
              currentTab === 'questions' ? 'bg-purple-100' : 'bg-transparent'
            ]">
              <i data-lucide="library" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">题库</span>
          </div>
        </button>

        <button @click="currentTab = 'upload'" :class="[
          'flex-1 py-4 px-4 text-center transition-all relative',
          currentTab === 'upload' ? 'text-purple-600' : 'text-gray-500'
        ]">
          <div v-if="currentTab === 'upload'"
            class="absolute top-0 left-1/2 transform -translate-x-1/2 w-8 h-1 bg-gradient-to-r from-purple-500 to-blue-500 rounded-b-full">
          </div>
          <div class="flex flex-col items-center space-y-1">
            <div :class="[
              'w-10 h-10 rounded-xl flex items-center justify-center transition-all',
              currentTab === 'upload' ? 'bg-purple-100' : 'bg-transparent'
            ]">
              <i data-lucide="scan-line" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">识别</span>
          </div>
        </button>
      </div>
    </div>

    <!-- 添加科目弹窗 -->
    <div v-if="showAddSubjectModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl bounce-in">
        <div class="p-8">
          <div class="text-center mb-6">
            <div class="gradient-bg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <i data-lucide="plus" class="w-8 h-8 text-white"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">添加新科目</h3>
            <p class="text-gray-500 text-sm mt-1">请输入科目名称，每行一个</p>
          </div>

          <textarea v-model="newSubjectsText" placeholder="例如：&#10;数学&#10;英语&#10;物理"
            class="w-full h-32 p-4 border border-gray-200 rounded-2xl resize-none input-glow mb-6"></textarea>

          <div class="flex space-x-3">
            <button @click="showAddSubjectModal = false"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-all font-medium">
              取消
            </button>
            <button @click="addSubjects"
              class="flex-1 py-3 px-4 btn-primary text-white rounded-2xl hover-glow font-medium">
              确认添加
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 转移题目弹窗 -->
    <div v-if="showTransferSubjectModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl bounce-in">
        <div class="p-8">
          <div class="text-center mb-6">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <i data-lucide="arrow-right" class="w-8 h-8 text-blue-500"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">转移题目</h3>
            <p class="text-gray-500 text-sm mt-1">将 "{{ sourceSubject }}" 的题目转移到其他科目</p>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择目标科目</label>
            <select v-model="targetSubject" class="w-full p-4 border border-gray-200 rounded-xl input-glow">
              <option value="">请选择目标科目</option>
              <option v-for="subject in availableTargetSubjects" :key="subject" :value="subject">{{ subject }}</option>
            </select>
          </div>

          <!-- 添加是否删除源题目的开关 -->
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-gray-700" :class="{ 'opacity-50': deleteSourceSubject }">
                转移后删除源科目中的题目
              </label>
              <div class="relative inline-block w-12 h-6 transition duration-200 ease-in-out"
                :class="{ 'opacity-50 cursor-not-allowed': deleteSourceSubject }">
                <input type="checkbox" v-model="deleteSourceAfterTransfer" :disabled="deleteSourceSubject"
                  class="opacity-0 absolute w-full h-full cursor-pointer z-10" />
                <div :class="[
                  'toggle-bg bg-gray-200 absolute h-6 w-12 rounded-full transition-all duration-300',
                  deleteSourceAfterTransfer ? 'bg-blue-500' : ''
                ]"></div>
                <div :class="[
                  'toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all duration-300 shadow-sm',
                  deleteSourceAfterTransfer ? 'transform translate-x-6' : ''
                ]"></div>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2" :class="{ 'opacity-50': deleteSourceSubject }">
              <span v-if="deleteSourceAfterTransfer" class="text-blue-500 font-medium">
                <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>已开启
              </span>
              <span v-else class="text-gray-400">
                <i data-lucide="minus" class="w-3 h-3 inline mr-1"></i>未开启
              </span>
              <span v-if="deleteSourceSubject">
                删除源科目时，题目将自动被删除
              </span>
              <span v-else>
                {{ deleteSourceAfterTransfer ? '转移完成后将从源科目中删除已转移的题目' : '转移后，原科目中的题目仍将保留' }}
              </span>
            </p>
          </div>

          <!-- 分隔线 -->
          <div class="divider"></div>

          <!-- 添加是否删除源科目的开关 -->
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <label class="text-sm font-medium text-gray-700">转移后删除源科目</label>
                <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-600 rounded-full text-xs font-medium">危险操作</span>
              </div>
              <div class="relative inline-block w-12 h-6 transition duration-200 ease-in-out">
                <input type="checkbox" v-model="deleteSourceSubject"
                  class="opacity-0 absolute w-full h-full cursor-pointer z-10" />
                <div :class="[
                  'toggle-bg bg-gray-200 absolute h-6 w-12 rounded-full transition-all duration-300',
                  deleteSourceSubject ? 'bg-red-500' : ''
                ]"></div>
                <div :class="[
                  'toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all duration-300 shadow-sm',
                  deleteSourceSubject ? 'transform translate-x-6' : ''
                ]"></div>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">
              <span v-if="deleteSourceSubject" class="text-red-500 font-medium">
                <i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i>已开启
              </span>
              <span v-else class="text-gray-400">
                <i data-lucide="minus" class="w-3 h-3 inline mr-1"></i>未开启
              </span>
              {{ deleteSourceSubject ? '转移完成后将删除整个源科目（包括其中的所有题目）' : '转移后，源科目将保留' }}
            </p>
            <div v-if="deleteSourceSubject" class="mt-2 p-2 bg-red-50 rounded-lg border border-red-100">
              <p class="text-xs text-red-600 flex items-start">
                <i data-lucide="alert-circle" class="w-3 h-3 mr-1 mt-0.5 flex-shrink-0"></i>
                <span>警告：此操作将永久删除"{{ sourceSubject }}"科目，包括其中的所有题目。此操作无法撤销。</span>
              </p>
            </div>
          </div>

          <div class="flex space-x-3">
            <button @click="showTransferSubjectModal = false"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-all font-medium">
              取消
            </button>
            <button @click="transferQuestions" :disabled="!targetSubject" :class="[
                'flex-1 py-3 px-4 rounded-2xl font-medium transition-all',
                targetSubject ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              ]">
              确认转移
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 题目详情弹窗 -->
    <div v-if="showQuestionDetailModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-white w-full h-full shadow-2xl bounce-in flex flex-col">
        <!-- 顶部导航栏 -->
        <div class="gradient-bg px-6 py-4 flex items-center justify-between">
          <div class="flex gap-2 items-center">
            <button @click="showQuestionDetailModal = false" class="text-white p-2 hover:bg-white/20 rounded-full">
              <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h3 class="text-lg font-bold text-white">题目详情</h3>
          </div>
          <div class="flex items-center space-x-3">
            <i data-lucide="type" class="w-4 h-4 text-white"></i>
            <input v-model="detailFontSize" type="range" min="8" max="48" step="1"
              class="w-32 h-2 bg-white/30 rounded-lg appearance-none cursor-pointer accent-white">
            <span class="text-white text-sm">{{ detailFontSize }}px</span>
          </div>
        </div>

        <!-- 内容区域 -->
        <div class="flex-1 overflow-y-auto p-6">
          <!-- 标签和科目 -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
              <span
                class="bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 px-3 py-1 rounded-full text-xs font-medium">
                {{ currentDetailQuestion.classification }}
              </span>
              <span class="text-xs text-gray-500">
                {{ currentDetailQuestion.subjects_name }}
              </span>
            </div>
          </div>

          <!-- 题目内容 -->
          <div class="mb-6">
            <h4 class="text-gray-500 text-sm mb-2">题目内容</h4>
            <p class="text-gray-800 leading-relaxed p-4 bg-gray-50 rounded-xl"
              :style="{ fontSize: `${detailFontSize}px` }">
              {{ currentDetailQuestion.title }}
            </p>
          </div>

          <!-- 答案解析 -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-gray-500 text-sm">答案解析</h4>
              <button @click="generateMoreAnswers"
                class="px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-xs hover:bg-purple-200 transition-colors flex items-center">
                <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i>
                生成更多答案
              </button>
            </div>
            <div class="p-4 bg-green-50 rounded-xl">
              <p class="text-green-700 font-medium" :style="{ fontSize: `${detailFontSize}px` }">{{
                currentDetailQuestion.answer }}</p>
            </div>
          </div>

          <!-- AI生成的多个答案 -->
          <div v-if="generatedAnswers.length > 0" class="mb-6">
            <h4 class="text-gray-500 text-sm mb-2">AI生成的答案</h4>
            <div v-for="(answer, index) in generatedAnswers" :key="index"
              class="p-4 bg-blue-50 rounded-xl mb-3 border border-blue-100">
              <div class="flex flex-col">
                <p class="text-blue-700 mb-3" :style="{ fontSize: `${detailFontSize}px` }">{{ answer.answer || answer }}
                </p>
                <div class="flex justify-end space-x-2">
                  <button @click="deleteGeneratedAnswer(index)"
                    class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs hover:bg-red-200 transition-colors flex items-center">
                    <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>
                    删除
                  </button>
                  <button @click="useGeneratedAnswer(answer.answer || answer)"
                    class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs hover:bg-blue-200 transition-colors flex items-center">
                    <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                    使用此答案
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 加载状态 -->
          <div v-if="isGeneratingAnswers" class="flex justify-center items-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            <span class="ml-2 text-purple-500">生成中...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加题目弹窗 -->
    <div v-if="showAddQuestionModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl bounce-in max-h-[90vh] flex flex-col">
        <!-- 顶部导航栏 -->
        <div class="gradient-bg px-6 py-4 rounded-t-3xl flex items-center justify-between">
          <button @click="showAddQuestionModal = false" class="text-white p-2 hover:bg-white/20 rounded-full">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>
          <h3 class="text-lg font-bold text-white">添加题目</h3>
          <div class="w-9"></div> <!-- 占位元素保持居中 -->
        </div>

        <!-- 内容区域 -->
        <div class="flex-1 overflow-y-auto p-6">
          <!-- 科目选择 -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择科目</label>
            <select v-model="newQuestion.subjects_name" class="w-full p-4 border border-gray-200 rounded-xl input-glow">
              <option value="">请选择科目</option>
              <option v-for="subject in subjects" :key="subject" :value="subject">{{ subject }}</option>
            </select>
          </div>

          <!-- 分类选择 -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择分类</label>
            <div class="flex flex-wrap gap-2">
              <button v-for="category in ['选择题', '填空题', '问答题', '计算题', '其他']" :key="category"
                @click="newQuestion.classification = category" :class="[
                  'px-4 py-2 rounded-full text-sm font-medium transition-all',
                  newQuestion.classification === category 
                    ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                ]">
                {{ category }}
              </button>
            </div>
          </div>

          <!-- 题目内容 -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">题目内容</label>
            <textarea v-model="newQuestion.title" placeholder="请输入题目内容..."
              class="w-full h-32 p-4 border border-gray-200 rounded-xl resize-none input-glow"></textarea>
          </div>

          <!-- 答案输入 -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <label class="block text-sm font-medium text-gray-700">答案</label>
              <button @click="generateAnswer" :disabled="!newQuestion.title || isGeneratingAnswer"
                class="px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-xs hover:bg-purple-200 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i>
                AI生成答案
              </button>
            </div>
            <textarea v-model="newQuestion.answer" placeholder="请输入答案或点击AI生成..."
              class="w-full h-32 p-4 border border-gray-200 rounded-xl resize-y input-glow"></textarea>
          </div>

          <!-- 加载状态 -->
          <div v-if="isGeneratingAnswer" class="flex justify-center items-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            <span class="ml-2 text-purple-500">生成中...</span>
          </div>

          <!-- 提交按钮 -->
          <button @click="addQuestion"
            :disabled="!newQuestion.title || !newQuestion.subjects_name || !newQuestion.classification"
            class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white py-4 rounded-2xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover-glow transition-all">
            添加题目
          </button>
        </div>
      </div>
    </div>

    <!-- 配置弹窗 -->
    <div v-if="showConfigModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl bounce-in max-h-[90vh] flex flex-col">
        <!-- 顶部导航栏 -->
        <div class="gradient-bg px-6 py-4 rounded-t-3xl flex items-center justify-between">
          <button @click="showConfigModal = false" class="text-white p-2 hover:bg-white/20 rounded-full">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>
          <h3 class="text-lg font-bold text-white">系统配置</h3>
          <div class="w-9"></div> <!-- 占位元素保持居中 -->
        </div>

        <!-- 内容区域 -->
        <div class="flex-1 overflow-y-auto p-6">
          <!-- 提示词配置 -->
          <div class="mb-6">
            <h4 class="text-lg font-medium text-gray-800 mb-4">AI 生成答案提示词配置</h4>

            <!-- 统一的答案生成提示词 -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">答案生成提示词</label>
              <div class="mb-2 text-xs text-gray-500">
                配置生成答案时的提示词，可使用以下变量标签：
              </div>
              <textarea v-model="config.answerPrompt" placeholder="请根据以下题目生成一个准确、详细的答案：{{title}}"
                class="w-full h-32 p-4 border border-gray-200 rounded-xl resize-none input-glow"></textarea>
            </div>

            <!-- 多个答案生成提示词 -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">多个答案生成提示词</label>
              <div class="mb-2 text-xs text-gray-500">
                配置生成多个答案时的提示词，可使用以下变量标签：
              </div>
              <textarea v-model="config.multipleAnswersPrompt" placeholder="请根据以下题目生成多个不同角度的答案，以帮助更全面理解题目：{{title}}"
                class="w-full h-32 p-4 border border-gray-200 rounded-xl resize-none input-glow"></textarea>
            </div>

            <!-- 可用变量标签 -->
            <div class="mb-6">
              <h5 class="text-sm font-medium text-gray-700 mb-2">可用变量标签：</h5>
              <div class="flex flex-wrap gap-2">
                <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs flex items-center">
                  <span class="text-blue-600">题目内容</span>
                  <span class="font-mono ml-1">title</span>
                </div>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs flex items-center">
                  <span class="text-green-600">科目</span>
                  <span class="font-mono ml-1">subject</span>
                </div>
                <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs flex items-center">
                  <span class="text-purple-600">分类</span>
                  <span class="font-mono ml-1">classification</span>
                </div>
                <div class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs flex items-center">
                  <span class="text-amber-600">模型</span>
                  <span class="font-mono ml-1">model</span>
                </div>
              </div>
            </div>

            <!-- 提示词测试区域 -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">提示词测试</label>
                <button @click="testPrompt()" :disabled="isTestingPrompt"
                  class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs hover:bg-blue-200 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                  <i data-lucide="zap" class="w-3 h-3 mr-1"></i>
                  测试提示词
                </button>
              </div>
              <textarea v-model="testPromptInput" placeholder="输入测试题目内容..."
                class="w-full h-20 p-4 border border-gray-200 rounded-xl resize-none input-glow mb-4"></textarea>

              <!-- 测试结果 -->
              <div v-if="testPromptResult" class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="text-xs font-medium text-gray-500 mb-2">测试结果：</div>
                <div v-if="Array.isArray(testPromptResult)">
                  <div v-for="(result, index) in testPromptResult" :key="index"
                    class="mb-2 p-2 bg-white rounded-lg border border-gray-100">
                    <div class="text-xs text-gray-500">答案 {{index + 1}}：</div>
                    <div class="text-sm text-gray-800">{{result}}</div>
                  </div>
                </div>
                <div v-else class="text-sm text-gray-800">{{testPromptResult}}</div>
              </div>

              <!-- 加载状态 -->
              <div v-if="isTestingPrompt" class="flex justify-center items-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                <span class="ml-2 text-blue-500 text-sm">测试中...</span>
              </div>
            </div>
          </div>

          <!-- 保存按钮 -->
          <div class="flex justify-end">
            <button @click="saveConfig"
              class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-3 rounded-xl font-medium hover-glow transition-all">
              保存配置
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 自定义提示词弹窗 -->
    <div v-if="showCustomPromptModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl bounce-in max-h-[90vh] flex flex-col">
        <!-- 顶部导航栏 -->
        <div class="gradient-bg px-6 py-4 rounded-t-3xl flex items-center justify-between">
          <button @click="showCustomPromptModal = false" class="text-white p-2 hover:bg-white/20 rounded-full">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>
          <h3 class="text-lg font-bold text-white">自定义提示词</h3>
          <div class="w-9"></div> <!-- 占位元素保持居中 -->
        </div>

        <!-- 内容区域 -->
        <div class="flex-1 overflow-y-auto p-6">
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">自定义提示词</label>
            <div class="mb-2 text-xs text-gray-500">
              使用 {{prompt}} 引用系统配置中的提示词，或使用以下变量标签：
            </div>
            <textarea v-model="customPrompt" placeholder="{{prompt}}&#10;&#10;可以在此添加额外的指导或上下文..."
              class="w-full h-32 p-4 border border-gray-200 rounded-xl resize-none input-glow"></textarea>
          </div>

          <!-- 可用变量标签 -->
          <div class="mb-6">
            <h5 class="text-sm font-medium text-gray-700 mb-2">可用变量标签：</h5>
            <div class="flex flex-wrap gap-2">
              <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs flex items-center">
                <span class="text-blue-600">题目内容</span>
                <span class="font-mono ml-1">title</span>
              </div>
              <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs flex items-center">
                <span class="text-green-600">科目</span>
                <span class="font-mono ml-1">subject</span>
              </div>
              <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs flex items-center">
                <span class="text-purple-600">分类</span>
                <span class="font-mono ml-1">classification</span>
              </div>
              <div class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs flex items-center">
                <span class="text-amber-600">模型</span>
                <span class="font-mono ml-1">model</span>
              </div>
              <div class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-xs flex items-center">
                <span class="text-pink-600">系统提示词</span>
                <span class="font-mono ml-1">prompt</span>
              </div>
            </div>
            <!-- 移除当前值展示部分 -->
          </div>

          <!-- 预览 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">最终提示词预览</label>
            <div
              class="p-4 bg-gray-50 rounded-xl border border-gray-200 text-sm text-gray-800 whitespace-pre-wrap max-h-[100px] overflow-y-auto">
              {{ processedCustomPrompt }}
            </div>
          </div>

          <!-- 按钮 -->
          <div class="flex space-x-3">
            <button @click="showCustomPromptModal = false"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-all font-medium">
              取消
            </button>
            <button @click="generateAnswerWithCustomPrompt" :disabled="isGeneratingAnswer"
              class="flex-1 py-3 px-4 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-2xl hover-glow font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              <div v-if="isGeneratingAnswer" class="flex items-center justify-center">
                <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
                生成中...
              </div>
              <div v-else>生成答案</div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 导入数据弹窗 -->
    <div v-if="showImportModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
      <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl bounce-in">
        <div class="p-8">
          <div class="text-center mb-6">
            <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <i data-lucide="upload" class="w-8 h-8 text-green-500"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">导入数据</h3>
            <p class="text-gray-500 text-sm mt-1">请选择导入方式</p>
          </div>

          <!-- 导入方式选择 -->
          <div class="mb-6">
            <div class="flex space-x-2">
              <button @click="importMethod = 'file'" :class="[
                'flex-1 py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center',
                importMethod === 'file' ? 'bg-green-100 text-green-700 border-2 border-green-300' : 'bg-gray-100 text-gray-700'
              ]">
                <i data-lucide="file" class="w-4 h-4 mr-2"></i>
                文件导入
              </button>
              <button @click="importMethod = 'text'" :class="[
                'flex-1 py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center',
                importMethod === 'text' ? 'bg-green-100 text-green-700 border-2 border-green-300' : 'bg-gray-100 text-gray-700'
              ]">
                <i data-lucide="code" class="w-4 h-4 mr-2"></i>
                文本导入
              </button>
            </div>
          </div>

          <!-- 文件导入 -->
          <div v-if="importMethod === 'file'" class="mb-6">
            <!-- 使用label包裹input更有利于移动设备触发文件选择 -->
            <label for="json-file-upload" class="block w-full cursor-pointer">
              <input type="file" id="json-file-upload" ref="importFileInput" @change="handleFileImport" accept=".json"
                class="hidden">
              <div
                class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-green-400 hover:bg-green-50 transition-all">
                <i data-lucide="file-json" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                <h4 class="text-base font-medium text-gray-800 mb-2">点击选择JSON文件</h4>
                <p class="text-gray-500 text-sm">支持.json格式</p>
                <p class="text-blue-500 text-sm mt-2">* 点击此区域选择文件 *</p>
                <div v-if="selectedFileName" class="mt-4 p-2 bg-green-50 rounded-lg text-green-700 text-sm">
                  已选择: {{ selectedFileName }}
                </div>
              </div>
            </label>
            <!-- 备用提示 -->
            <div class="mt-3 text-center">
              <p class="text-xs text-gray-500">在移动设备上如果无法选择文件，请切换到<button @click="importMethod = 'text'"
                  class="text-blue-500 underline">文本导入</button>方式</p>
            </div>
          </div>

          <!-- JSON文本导入 -->
          <div v-if="importMethod === 'text'" class="mb-6">
            <textarea v-model="importDataText" placeholder="请粘贴JSON格式的数据..." @paste="handlePaste"
              class="w-full h-64 p-4 border border-gray-200 rounded-2xl resize-none input-glow font-mono text-sm mb-3"></textarea>
          </div>

          <div class="flex space-x-3">
            <button @click="showImportModal = false"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-all font-medium">
              取消
            </button>
            <button @click="importData"
              class="flex-1 py-3 px-4 bg-green-500 text-white rounded-2xl hover:bg-green-600 transition-all font-medium">
              确认导入
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 不允许修改
    class ParseTextTools {
      /**
       * 将中文标点符号转换为英文标点符号
       * @param {string} text - 包含中文标点的文本
       * @return {string} 转换后的文本
       */
      convertChineseSymbols(text) {
        return text
          .replace(/，/g, ",") // 逗号
          .replace(/。/g, ".") // 句号
          .replace(/？/g, "?") // 问号
          .replace(/！/g, "!") // 感叹号
          .replace(/；/g, ";") // 分号
          .replace(/：/g, ":") // 冒号
          .replace(/"/g, '"') // 左双引号
          .replace(/"/g, '"') // 右双引号
          .replace(/'/g, "'") // 左单引号
          .replace(/'/g, "'") // 右单引号
          .replace(/（/g, "(") // 左括号
          .replace(/）/g, ")") // 右括号
          .replace(/【/g, "[") // 左方括号
          .replace(/】/g, "]") // 右方括号
          .replace(/—/g, "-") // 破折号
          .replace(/…/g, "...") // 省略号
          .replace(/\s+/g, " "); // 空格
      }

      /**
       * 判断题目类型
       * @param {string} title - 题目标题
       * @param {string} answer - 题目答案
       * @return {string} 题目类型
       */
      determineQuestionType(title, answer) {
        // 判断题
        if (
          title.includes("判断") ||
          answer.trim() === "对" ||
          answer.trim() === "错" ||
          answer.trim() === "正确" ||
          answer.trim() === "错误" ||
          answer.trim() === "T" ||
          answer.trim() === "F"
        ) {
          return "判断题";
        }

        if (answer.indexOf("(1)") !== -1 || /\(\d+\)/.test(answer)) {
          return "论述题";
        }

        // 多选题 - 多个选项，通常用逗号或空格分隔
        if (
          /[A-D][,，\s]+[A-D]/.test(answer) ||
          (answer.match(/[A-D]/g) || []).length >= 2 ||
          answer.split(/\s|,/).length >= 2
        ) {
          return "多选题";
        }

        return "单选题";
      }


      /**
       * 提取学科名称
       * @param {string} title - 题目标题
       * @return {string} 学科名称
       */
      extractSubjectName(title) {
        // 基于题目关键词判断学科
        const subjects = {
          '心理学': ['心理', '认知', '行为'],
          '管理学': ['管理', '团体', '组织', '领导'],
          '计算机': ['编程', '算法', '数据结构'],
          '数学': ['数学', '代数', '几何']
        };

        for (const [subject, keywords] of Object.entries(subjects)) {
          for (const keyword of keywords) {
            if (title.includes(keyword)) {
              return subject;
            }
          }
        }
        return '未分类';
      }


      /**
       * 解析题目文本
       * @param {string} text - 输入的题目文本
       * @return {Array} 解析后的结构化数据
       */
      parseQuestions(text, subjects_name = "") {
        const results = [];
        // 将顿号左右空格去除
        text = text.replace(/\s*、\s*/g, "、")
        const convertedText = this.convertChineseSymbols(text);
        // const r = /\d+、[^]*?(?=(?:^|[^\d])\d+、|$)/g
        const r = /\d+、[^]*?(?=\d+、|$)/g;

        // 分割每道题目
        const textSplits = Array.from(convertedText.match(r) || [])
          .map((f) => f.trim())
          .filter(Boolean);

        textSplits.forEach((f) => {
          // 匹配题号、题目和答案
          const r = f.match(/(\d+)、([^(:]+)(?:[:]?\s*)?(.+)/s);

          if (r) {
            const [_, n, rawTitle, rawAnswer] = r;
            const title = rawTitle.trim();
            let answer = rawAnswer.trim();

            // 如果开头结尾都是括号，则去掉
            if (answer.startsWith("(") && answer.endsWith(")")) {
              answer = answer.slice(1, -1);
            }
            // 判断题目类型
            const classification = this.determineQuestionType(title, answer);
            // 构建结果对象
            results.push({
              subjects_name: subjects_name || this.extractSubjectName(title),
              classification,
              title,
              answer,
            });
          } else {
            console.log("解析错误", f);
          }
        });
        return results;
      }
    }
    const ptTool = new ParseTextTools()
  </script>

  <script>
    // 初始化 Lucide 图标
    lucide.createIcons();
    const token = "pat_xFzog6n08JTkmagiXDJenxqBm7fH7euZlh9Gct8icgQL6TfbZWCC1Mo5thfqdBhr";

    /**
     * 调用Coze工作流API的函数
     * @param {string} token - 认证令牌
     * @param {object} parameters - 工作流参数（默认空对象）
     * @returns {Promise<object>} - 包含API响应的Promise对象
     */
    async function callCozeWorkflow(token, parameters = {}, workflow_id = "7495579045846057010") {
      try {
        // 发送Fetch请求
        const response = await fetch("https://api.coze.cn/v1/workflow/run", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            workflow_id,
            parameters: parameters,
          }),
        });

        // 检查响应状态
        if (!response.ok) {
          throw new Error(`HTTP错误！状态码：${response.status}`);
        }

        // 解析JSON响应
        return await response.json();
      } catch (error) {
        console.error("调用工作流API失败:", error);
        throw error;
      }
    }

    const { createApp, ref, computed, onMounted, watch } = Vue;

    const App = {
      setup() {
        // 响应式状态
        const currentTab = ref('subjects');
        const subjects = ref([]);
        const questions = ref([]);
        const searchQuery = ref('');
        const selectedCategory = ref('');
        const fontSize = ref(16);
        const showAddSubjectModal = ref(false);
        const newSubjectsText = ref('');
        const uploadedImage = ref(null);
        const textInput = ref('');
        const selectedSubjectForUpload = ref('');
        const isProcessing = ref(false);
        const selectedSubjectFilter = ref('');
        const fileInput = ref(null);
        const uploadMode = ref('image');
        const selectedModel = ref('doubao');
        const showTransferSubjectModal = ref(false);
        const targetSubject = ref('');
        const sourceSubject = ref('');
        const availableTargetSubjects = ref([]);
        const deleteSourceAfterTransfer = ref(false);
        const deleteSourceSubject = ref(false);
        const showImportModal = ref(false);
        const importDataText = ref('');
        const importMethod = ref('file');
        const importFileInput = ref(null);
        const selectedFileName = ref('');

        // 题目详情相关状态
        const showQuestionDetailModal = ref(false);
        const currentDetailQuestion = ref({});
        const generatedAnswers = ref([]);
        const isGeneratingAnswers = ref(false);
        const detailFontSize = ref(16); // 添加题目详情页面的字体大小控制
        let fontSizeInterval = null; // 用于长按调整字体大小的定时器

        // 添加题目相关状态
        const showAddQuestionModal = ref(false);
        const newQuestion = ref({
          subjects_name: '',
          classification: '',
          title: '',
          answer: ''
        });
        const isGeneratingAnswer = ref(false);
        const showCustomPromptModal = ref(false);
        const customPrompt = ref('{{prompt}}');
        const processedCustomPrompt = computed(() => {
          let result = customPrompt.value;

          // 替换系统提示词
          result = result.replace(/{{prompt}}/g, config.value.answerPrompt);

          // 替换其他变量
          result = result.replace(/{{title}}/g, newQuestion.value.title || '[题目内容]');
          result = result.replace(/{{subject}}/g, newQuestion.value.subjects_name || '[科目名称]');
          result = result.replace(/{{classification}}/g, newQuestion.value.classification || '[题目分类]');
          result = result.replace(/{{model}}/g, selectedModel.value);

          return result;
        });

        // 配置相关状态
        const showConfigModal = ref(false);
        const config = ref({
          answerPrompt: '请根据以下题目生成一个准确、详细的答案：{{title}}',
          multipleAnswersPrompt: '请根据以下题目生成多个不同角度的答案，以帮助更全面理解题目：{{title}}'
        });
        const testPromptInput = ref('');
        const testPromptResult = ref(null);
        const isTestingPrompt = ref(false);

        // 通知系统
        const notifications = ref([]);
        let notificationId = 0;

        // 添加通知
        const addNotification = (config) => {
          const id = notificationId++;
          const notification = {
            id,
            type: config.type || 'info',
            title: config.title || '',
            message: config.message,
            autoClose: config.autoClose !== false,
            duration: config.duration || 5000,
            onConfirm: config.onConfirm || (() => { }),
            onCancel: config.onCancel || (() => { })
          };

          notifications.value.push(notification);

          if (notification.autoClose && notification.type !== 'confirm') {
            setTimeout(() => {
              removeNotification(id);
            }, notification.duration);
          }

          return id;
        };

        // 移除通知
        const removeNotification = (id) => {
          const index = notifications.value.findIndex(n => n.id === id);
          if (index !== -1) {
            notifications.value.splice(index, 1);
          }
        };

        // 获取进度条颜色
        const getProgressColor = (type) => {
          const colors = {
            info: '#3b82f6',
            success: '#22c55e',
            warning: '#f59e0b',
            error: '#ef4444',
            confirm: '#8b5cf6'
          };
          return colors[type] || colors.info;
        };

        // 通知方法
        const notify = {
          info: (message, title) => {
            return addNotification({ type: 'info', message, title });
          },
          success: (message, title) => {
            return addNotification({ type: 'success', message, title });
          },
          warning: (message, title) => {
            return addNotification({ type: 'warning', message, title });
          },
          error: (message, title) => {
            return addNotification({ type: 'error', message, title });
          },
          confirm: (message, onConfirm, onCancel, title) => {
            return addNotification({
              type: 'confirm',
              message,
              title,
              autoClose: false,
              onConfirm: onConfirm || (() => { }),
              onCancel: onCancel || (() => { })
            });
          }
        };

        // 计算属性
        const categories = computed(() => {
          const cats = [...new Set(questions.value.map(q => q.classification))];
          return cats.filter(cat => cat);
        });

        // 添加拼音首字母转换函数
        const getPinyinInitials = (text) => {
          try {
            return pinyinPro.pinyin(text, { pattern: 'first', toneType: 'none', type: 'array' }).join('')
          } catch (e) {
            console.error('拼音转换错误:', e);
            return ''
          }
        };

        const filteredQuestions = computed(() => {
          let filtered = questions.value;

          if (selectedSubjectFilter.value) {
            filtered = filtered.filter(q => q.subjects_name === selectedSubjectFilter.value);
          }

          if (searchQuery.value) {
            const query = searchQuery.value.toLowerCase();
            filtered = filtered.filter(q => {
              // 原文本匹配
              const titleMatch = q.title.toLowerCase().includes(query);
              const answerMatch = q.answer.toLowerCase().includes(query);
              const subjectMatch = q.subjects_name.toLowerCase().includes(query);

              // 拼音首字母匹配
              const titlePinyinMatch = getPinyinInitials(q.title).includes(query);
              const answerPinyinMatch = getPinyinInitials(q.answer).includes(query);

              return titleMatch || answerMatch || subjectMatch || titlePinyinMatch || answerPinyinMatch;
            });
          }

          if (selectedCategory.value) {
            filtered = filtered.filter(q => q.classification === selectedCategory.value);
          }

          return filtered;
        });

        const todayQuestions = computed(() => {
          // 模拟今日新增题目数量
          return Math.floor(Math.random() * 10) + 1;
        });

        // 本地存储相关方法
        const saveToLocalStorage = () => {
          localStorage.setItem('smartQuizApp_subjects', JSON.stringify(subjects.value));
          localStorage.setItem('smartQuizApp_questions', JSON.stringify(questions.value));
        };

        const loadFromLocalStorage = () => {
          const storedSubjects = localStorage.getItem('smartQuizApp_subjects');
          const storedQuestions = localStorage.getItem('smartQuizApp_questions');

          if (storedSubjects) {
            subjects.value = JSON.parse(storedSubjects);
          }
          if (storedQuestions) {
            questions.value = JSON.parse(storedQuestions);
          }
        };

        // 科目管理
        const addSubjects = () => {
          if (newSubjectsText.value.trim()) {
            const newSubjects = newSubjectsText.value
              .split('\n')
              .map(s => s.trim())
              .filter(s => s && !subjects.value.includes(s));

            subjects.value.push(...newSubjects);
            saveToLocalStorage();
            newSubjectsText.value = '';
            showAddSubjectModal.value = false;

            // 重新初始化图标
            setTimeout(() => lucide.createIcons(), 100);
          }
        };

        const selectSubject = (subject) => {
          selectedCategory.value = '';
          searchQuery.value = '';
          currentTab.value = 'questions';
          selectedSubjectFilter.value = subject;
        };

        const getSubjectQuestionCount = (subject) => {
          return questions.value.filter(q => q.subjects_name === subject).length;
        };

        const clearSubjectFilter = () => {
          selectedSubjectFilter.value = '';
          searchQuery.value = '';
        };

        // 文件上传处理
        const handleFileUpload = (event) => {
          const file = event.target.files[0];
          if (file) {
            // 检查文件大小（限制为10MB）
            if (file.size > 10 * 1024 * 1024) {
              notify.error('文件大小不能超过10MB');
              if (fileInput.value) {
                fileInput.value.value = '';
              }
              return;
            }

            // 检查文件类型
            if (!file.type.startsWith('image/')) {
              notify.error('请上传图片文件');
              if (fileInput.value) {
                fileInput.value.value = '';
              }
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              // 将图片转换为base64格式
              uploadedImage.value = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        };

        const clearUploadedImage = () => {
          uploadedImage.value = null;
          if (fileInput.value) {
            fileInput.value.value = '';
          }
        };

        // 模拟处理上传
        const processUpload = async () => {
          if ((!uploadedImage.value && !textInput.value) || !selectedSubjectForUpload.value) {
            return;
          }

          isProcessing.value = true;

          // 处理科目名称：如果科目已存在，添加随机后缀；如果不存在，直接使用
          let subjects_name = selectedSubjectForUpload.value;
          if (subjects.value.includes(subjects_name)) {
            // 如果科目已存在，添加随机后缀
            const randomNumber = Math.floor(Math.random() * 10000);
            subjects_name = `${subjects_name}(AI识别 ${randomNumber})`;
          }

          // 定义使用备用数据的函数
          const useBackupData = (subjects_name) => {
            const backupQuestions = [
              {
                subjects_name: subjects_name,
                classification: '选择题',
                title: textInput.value || '根据图片识别：下列哪个选项是Vue 3的新特性？',
                answer: 'A. Composition API'
              },
              {
                subjects_name: subjects_name,
                classification: '问答题',
                title: 'Vue 3中setup函数的作用是什么？',
                answer: 'setup函数是Vue 3 Composition API的入口点，用于定义组件的响应式数据、计算属性和方法。'
              },
              {
                subjects_name: subjects_name,
                classification: '填空题',
                title: 'Vue 3使用___语法来创建响应式引用',
                answer: 'ref()'
              }
            ];

            // 题目去重处理
            const existingTitles = new Set(questions.value.map(q => q.title.trim()));
            const uniqueQuestions = backupQuestions.filter(q => !existingTitles.has(q.title.trim()));

            // 如果有重复题目，显示提示
            const duplicateCount = backupQuestions.length - uniqueQuestions.length;
            if (duplicateCount > 0) {
              notify.warning(`已过滤 ${duplicateCount} 道重复题目`);
            }

            // 添加到题目列表
            questions.value.push(...uniqueQuestions);

            // 如果科目不在列表中，添加到科目列表
            if (!subjects.value.includes(subjects_name)) {
              subjects.value.push(subjects_name);
            }

            // 保存到本地存储
            saveToLocalStorage();

            // 清空输入
            uploadedImage.value = null;
            textInput.value = '';
            selectedSubjectForUpload.value = '';
            if (fileInput.value) {
              fileInput.value.value = '';
            }

            // 跳转到题目页面
            currentTab.value = 'questions';
            // 设置筛选器为当前上传的科目
            selectedSubjectFilter.value = subjects_name;

            // 重置处理状态
            isProcessing.value = false;

            // 重新初始化图标
            setTimeout(() => lucide.createIcons(), 100);
          };

          // 处理API返回的数据
          const processApiData = (data, subjects_name) => {
            try {
              const data_json = JSON.parse(data);
              console.log(data, data_json);
              const output = data_json.output
              if (output && Array.isArray(output)) {
                if (output.length === 0) {
                  // 如果没有解析出数据，打开debug_url
                  if (result.debug_url) {
                    window.open(result.debug_url, '_blank');
                    notify.warning('未能解析出题目数据，已打开调试页面');
                  } else {
                    notify.error('未能解析出题目数据，且没有调试链接');
                  }
                  isProcessing.value = false;
                  return; // 终止后续执行
                }

                // 假设API返回的是题目数组
                const recognizedQuestions = output.map(item => ({
                  subjects_name: subjects_name,
                  classification: item.classification || '未分类',
                  title: item.title || '未识别题目',
                  answer: item.answer || '未识别答案',
                  answers: [] // 初始化空的 answers 数组
                }));

                // 题目去重处理
                const existingTitles = new Set(questions.value.map(q => q.title.trim()));
                const uniqueQuestions = recognizedQuestions.filter(q => !existingTitles.has(q.title.trim()));

                // 如果有重复题目，显示提示
                const duplicateCount = recognizedQuestions.length - uniqueQuestions.length;
                if (duplicateCount > 0) {
                  notify.warning(`已过滤 ${duplicateCount} 道重复题目`);
                }

                // 添加到题目列表
                questions.value.push(...uniqueQuestions);

                // 如果科目不在列表中，添加到科目列表
                if (!subjects.value.includes(subjects_name)) {
                  subjects.value.push(subjects_name);
                }

                // 保存到本地存储
                saveToLocalStorage();

                // 清空输入
                uploadedImage.value = null;
                textInput.value = '';
                selectedSubjectForUpload.value = '';
                if (fileInput.value) {
                  fileInput.value.value = '';
                }

                // 跳转到题目页面
                currentTab.value = 'questions';
                // 设置筛选器为当前上传的科目
                selectedSubjectFilter.value = subjects_name;

                // 重置处理状态
                isProcessing.value = false;

                // 重新初始化图标
                setTimeout(() => lucide.createIcons(), 100);
              } else {
                // 如果output不是数组或不存在，也打开debug_url
                if (result.debug_url) {
                  window.open(result.debug_url, '_blank');
                  notify.warning('返回数据格式不正确，已打开调试页面');
                } else {
                  notify.error('返回数据格式不正确，且没有调试链接');
                }
                isProcessing.value = false;
              }
            } catch (error) {
              console.error('解析API响应失败:', error);

              // 解析失败，处理debug_url
              if (result.debug_url) {
                window.open(result.debug_url, '_blank');
                notify.warning('解析API响应失败，已打开调试页面');

                // 询问用户是否要使用备用数据
                notify.confirm(
                  '是否要使用备用数据继续？',
                  () => {
                    // 用户确认，使用备用数据继续
                    useBackupData(subjects_name);
                  },
                  () => {
                    // 用户取消，终止执行
                    isProcessing.value = false;
                  },
                  '确认操作'
                );
              } else {
                notify.error('解析API响应失败，且没有调试链接');
                // 没有调试链接，直接使用备用数据
                useBackupData(subjects_name);
              }
            }
          };

          try {
            // 准备参数
            const parameters = {
              input: textInput.value || "",
              model: selectedModel.value,
              // image: uploadedImage.value || null // 图片已经是base64格式
            };

            // 调用Coze工作流API
            const result = await callCozeWorkflow(token, parameters);
            console.log("API响应:", result);

            // 处理API返回的数据
            processApiData(result.data, subjects_name);
          } catch (error) {
            console.error('处理失败:', error);
            notify.error('处理失败，请稍后重试');
            isProcessing.value = false;
          }
        };

        // 科目删除功能
        const confirmDeleteSubject = (subject) => {
          notify.confirm(
            `确定要删除科目 "${subject}" 吗？相关的所有题目也会被删除。`,
            () => {
              // 确认删除
              const index = subjects.value.indexOf(subject);
              if (index !== -1) {
                subjects.value.splice(index, 1);
                questions.value = questions.value.filter(q => q.subjects_name !== subject);
                saveToLocalStorage();
                notify.success(`已删除科目 "${subject}"`);
              }
            },
            () => {
              // 取消删除
            },
            '确认删除'
          );
        };

        // 题目删除功能
        const confirmDeleteQuestion = (question) => {
          notify.confirm(
            `确定要删除这道题目吗？\n${question.title.substring(0, 50)}${question.title.length > 50 ? '...' : ''}`,
            () => {
              // 确认删除
              const index = questions.value.indexOf(question);
              if (index !== -1) {
                questions.value.splice(index, 1);
                saveToLocalStorage();
                notify.success('已删除题目');
              }
            },
            () => {
              // 取消删除
            },
            '确认删除'
          );
        };

        // 题目转移功能
        const showTransferModal = (subject) => {
          sourceSubject.value = subject;
          // 过滤掉源科目，只显示其他科目作为目标选项
          availableTargetSubjects.value = subjects.value.filter(s => s !== subject);
          targetSubject.value = '';
          deleteSourceAfterTransfer.value = false; // 重置开关状态
          deleteSourceSubject.value = false; // 重置删除源科目开关状态
          showTransferSubjectModal.value = true;
        };

        const transferQuestions = () => {
          if (!targetSubject.value) return;

          // 找到源科目的所有题目
          const sourceQuestions = questions.value.filter(q => q.subjects_name === sourceSubject.value);

          // 创建复制的题目，并更改科目名称
          const copiedQuestions = sourceQuestions.map(q => ({
            ...q,
            subjects_name: targetSubject.value
          }));

          // 添加到题目列表中
          questions.value.push(...copiedQuestions);

          // 如果开启了删除源题目的选项，则删除源科目中的题目
          if (deleteSourceAfterTransfer.value) {
            questions.value = questions.value.filter(q => q.subjects_name !== sourceSubject.value);
          }

          // 如果开启了删除源科目的选项，则删除源科目
          if (deleteSourceSubject.value) {
            const index = subjects.value.indexOf(sourceSubject.value);
            if (index !== -1) {
              subjects.value.splice(index, 1);
              // 如果没有删除题目，则需要在这里删除
              if (!deleteSourceAfterTransfer.value) {
                questions.value = questions.value.filter(q => q.subjects_name !== sourceSubject.value);
              }
            }
          }

          // 保存到本地存储
          saveToLocalStorage();

          // 显示成功提示
          let message = `已成功将 ${copiedQuestions.length} 道题目从 "${sourceSubject.value}" 转移到 "${targetSubject.value}"`;
          if (deleteSourceAfterTransfer.value) {
            message += `，并已从源科目中删除题目`;
          }
          if (deleteSourceSubject.value) {
            message += `，源科目"${sourceSubject.value}"已被删除`;
          }
          notify.success(message);

          // 关闭弹窗
          showTransferSubjectModal.value = false;

          // 重新初始化图标
          setTimeout(() => lucide.createIcons(), 100);
        };

        // 题目详情相关方法
        const showQuestionDetail = (question) => {
          currentDetailQuestion.value = question;
          showQuestionDetailModal.value = true;
          // 加载保存的生成答案
          loadGeneratedAnswers();
          // 重新初始化图标
          setTimeout(() => lucide.createIcons(), 100);
        };

        // 生成更多答案
        const generateMoreAnswers = async () => {
          if (!currentDetailQuestion.value.title || isGeneratingAnswers.value) return;

          isGeneratingAnswers.value = true;

          try {
            // 准备参数和提示词
            const prompt = config.value.multipleAnswersPrompt.replace('{{title}}', currentDetailQuestion.value.title);

            // 准备参数
            const parameters = {
              input: prompt,
              model: selectedModel.value,
              action: "generate_answer"
            };

            // 调用Coze工作流API
            const result = await callCozeWorkflow(token, parameters);
            console.log("生成答案API响应:", result);

            try {
              const data_json = JSON.parse(result.data);
              if (data_json && data_json.output && Array.isArray(data_json.output)) {
                // 确保当前题目有 answers 数组
                if (!currentDetailQuestion.value.answers) {
                  currentDetailQuestion.value.answers = [];
                }

                // 处理新答案
                const newAnswers = data_json.output.map(item => {
                  // 处理可能的不同数据结构
                  if (typeof item === 'string') {
                    return { answer: item };
                  } else if (item && item.answer) {
                    return item;
                  } else {
                    return { answer: JSON.stringify(item) };
                  }
                });

                // 将新答案添加到题目的 answers 数组中
                currentDetailQuestion.value.answers.push(...newAnswers);

                // 更新生成的答案列表（用于显示）
                generatedAnswers.value = [...currentDetailQuestion.value.answers];

                // 更新原始题目列表中的数据
                updateQuestionWithAnswers();
              } else {
                // 模拟生成的答案
                const mockAnswers = [
                  { answer: "这是AI生成的第一个答案，可能更加详细或有不同角度的解释。" },
                  { answer: "这是AI生成的另一个答案，提供了不同的思路或解法。" }
                ];

                // 确保当前题目有 answers 数组
                if (!currentDetailQuestion.value.answers) {
                  currentDetailQuestion.value.answers = [];
                }

                // 将模拟答案添加到题目的 answers 数组中
                currentDetailQuestion.value.answers.push(...mockAnswers);

                // 更新生成的答案列表（用于显示）
                generatedAnswers.value = [...currentDetailQuestion.value.answers];

                // 更新原始题目列表中的数据
                updateQuestionWithAnswers();
              }
            } catch (error) {
              console.error('解析API响应失败:', error);
              // 使用备用数据
              const backupAnswers = [
                { answer: "这是AI生成的第一个答案，可能更加详细或有不同角度的解释。" },
                { answer: "这是AI生成的另一个答案，提供了不同的思路或解法。" }
              ];

              // 确保当前题目有 answers 数组
              if (!currentDetailQuestion.value.answers) {
                currentDetailQuestion.value.answers = [];
              }

              // 将备用答案添加到题目的 answers 数组中
              currentDetailQuestion.value.answers.push(...backupAnswers);

              // 更新生成的答案列表（用于显示）
              generatedAnswers.value = [...currentDetailQuestion.value.answers];

              // 更新原始题目列表中的数据
              updateQuestionWithAnswers();
            }
          } catch (error) {
            console.error('生成答案失败:', error);
            notify.error('生成答案失败，请稍后重试');
            // 使用备用数据
            const backupAnswers = [
              { answer: "这是AI生成的第一个答案，可能更加详细或有不同角度的解释。" },
              { answer: "这是AI生成的另一个答案，提供了不同的思路或解法。" }
            ];

            // 确保当前题目有 answers 数组
            if (!currentDetailQuestion.value.answers) {
              currentDetailQuestion.value.answers = [];
            }

            // 将备用答案添加到题目的 answers 数组中
            currentDetailQuestion.value.answers.push(...backupAnswers);

            // 更新生成的答案列表（用于显示）
            generatedAnswers.value = [...currentDetailQuestion.value.answers];

            // 更新原始题目列表中的数据
            updateQuestionWithAnswers();
          } finally {
            isGeneratingAnswers.value = false;
          }
        };

        // 删除生成的答案
        const deleteGeneratedAnswer = (index) => {
          if (index >= 0 && index < generatedAnswers.value.length) {
            // 从当前题目的 answers 数组中删除
            if (currentDetailQuestion.value.answers) {
              currentDetailQuestion.value.answers.splice(index, 1);
            }

            // 更新生成的答案列表（用于显示）
            generatedAnswers.value = [...currentDetailQuestion.value.answers];

            // 更新原始题目列表中的数据
            updateQuestionWithAnswers();
          }
        };

        // 更新原始题目列表中的答案数据
        const updateQuestionWithAnswers = () => {
          const index = questions.value.findIndex(q =>
            q.title === currentDetailQuestion.value.title &&
            q.subjects_name === currentDetailQuestion.value.subjects_name
          );

          if (index !== -1) {
            // 更新原始题目的 answers 数组
            questions.value[index].answers = [...currentDetailQuestion.value.answers];
            saveToLocalStorage();
          }
        };

        // 加载生成的答案
        const loadGeneratedAnswers = () => {
          // 如果当前题目已有 answers 数组，则使用它
          if (currentDetailQuestion.value.answers && Array.isArray(currentDetailQuestion.value.answers)) {
            generatedAnswers.value = [...currentDetailQuestion.value.answers];
          } else {
            // 否则初始化为空数组
            currentDetailQuestion.value.answers = [];
            generatedAnswers.value = [];
          }
        };

        // 使用生成的答案
        const useGeneratedAnswer = (answer) => {
          currentDetailQuestion.value = {
            ...currentDetailQuestion.value,
            answer: answer
          };

          // 更新原始题目列表中的答案
          const index = questions.value.findIndex(q =>
            q.title === currentDetailQuestion.value.title &&
            q.subjects_name === currentDetailQuestion.value.subjects_name
          );

          if (index !== -1) {
            questions.value[index].answer = answer;
            // 不修改 answers 数组，保持原样
            saveToLocalStorage();
            notify.success('已更新题目答案');
          }
        };

        // 添加题目相关方法
        const generateAnswer = async () => {
          if (!newQuestion.value.title || isGeneratingAnswer.value) return;

          // 显示自定义提示词弹窗
          customPrompt.value = '{{prompt}} {{title}}';
          showCustomPromptModal.value = true;
        };

        // 使用自定义提示词生成答案
        const generateAnswerWithCustomPrompt = async () => {
          if (!newQuestion.value.title || isGeneratingAnswer.value) return;

          isGeneratingAnswer.value = true;
          showCustomPromptModal.value = false;

          try {
            // 使用处理后的自定义提示词
            const prompt = processedCustomPrompt.value;

            // 准备参数
            const parameters = {
              input: prompt,
              model: selectedModel.value,
              action: "generate_answer"
            };

            // 调用Coze工作流API
            const result = await callCozeWorkflow(token, parameters);
            console.log("生成答案API响应:", result);

            try {
              const data_json = JSON.parse(result.data);
              if (data_json && data_json.output) {
                newQuestion.value.answer = data_json.output[0].answer;
              } else {
                // 模拟生成的答案
                newQuestion.value.answer = "这是AI生成的答案，基于题目内容自动生成。";
              }
            } catch (error) {
              console.error('解析API响应失败:', error);
              // 使用备用数据
              newQuestion.value.answer = "这是AI生成的答案，基于题目内容自动生成。";
            }
          } catch (error) {
            console.error('生成答案失败:', error);
            notify.error('生成答案失败，请稍后重试');
            // 使用备用数据
            newQuestion.value.answer = "这是AI生成的答案，基于题目内容自动生成。";
          } finally {
            isGeneratingAnswer.value = false;
          }
        };

        // 添加题目
        const addQuestion = () => {
          if (!newQuestion.value.title || !newQuestion.value.subjects_name || !newQuestion.value.classification) {
            notify.warning('请完善题目信息');
            return;
          }

          // 添加到题目列表
          questions.value.push({
            subjects_name: newQuestion.value.subjects_name,
            classification: newQuestion.value.classification,
            title: newQuestion.value.title,
            answer: newQuestion.value.answer || '暂无答案',
            answers: [] // 初始化空的 answers 数组
          });

          // 保存到本地存储
          saveToLocalStorage();

          // 显示成功提示
          notify.success('已成功添加题目');

          // 重置表单
          newQuestion.value = {
            subjects_name: '',
            classification: '',
            title: '',
            answer: ''
          };

          // 关闭弹窗
          showAddQuestionModal.value = false;
        };

        // ========== 懒加载分页相关状态 ==========
        /**
         * @type {import('vue').Ref<number>} 当前已加载的题目数量
         */
        const questionPageSize = 20; // 每页加载数量
        const loadedQuestionCount = ref(questionPageSize); // 当前已加载数量
        /**
         * @type {import('vue').Ref<HTMLElement|null>} 题目列表容器ref
         */
        const questionListContainer = ref(null);
        /**
         * @type {import('vue').ComputedRef<Array>} 当前分页后实际渲染的题目
         */
        const pagedQuestions = computed(() => filteredQuestions.value.slice(0, loadedQuestionCount.value));
        /**
         * @function resetQuestionPagination
         * @description 重置分页（如切换筛选/搜索时）
         */
        function resetQuestionPagination() {
          loadedQuestionCount.value = questionPageSize;
        }
        // 监听筛选/搜索变化时重置分页
        watch([filteredQuestions, searchQuery, selectedCategory, selectedSubjectFilter], resetQuestionPagination);
        /**
         * @type {import('vue').Ref<boolean>} 是否正在加载更多
         */
        const isLoadingMore = ref(false);
        /**
         * @type {import('vue').ComputedRef<boolean>} 是否已全部加载完毕
         */
        const isAllLoaded = computed(() => loadedQuestionCount.value >= filteredQuestions.value.length);
        /**
         * @type {number} 上次提示的题目数量
         */
        let lastNotifiedCount = 0;
        /**
         * @function handleQuestionListScroll
         * @description 懒加载滚动监听，距离底部100px时加载更多，并显示提示
         */
        function handleQuestionListScroll() {
          const el = questionListContainer.value;
          if (!el) return;
          // 距离底部100px以内时加载
          if (el.scrollHeight - el.scrollTop - el.clientHeight < 100) {
            if (loadedQuestionCount.value < filteredQuestions.value.length) {
              if (!isLoadingMore.value) {
                isLoadingMore.value = true;
                // notify.info('正在加载更多...');
                setTimeout(() => {
                  loadedQuestionCount.value = Math.min(
                    loadedQuestionCount.value + questionPageSize,
                    filteredQuestions.value.length
                  );
                  isLoadingMore.value = false;
                  // 如果加载后全部加载完，给出提示
                  if (loadedQuestionCount.value >= filteredQuestions.value.length && lastNotifiedCount !== loadedQuestionCount.value) {
                    // notify.info('已全部加载完毕');
                    lastNotifiedCount = loadedQuestionCount.value;
                  }
                }, 300); // 模拟加载延迟
              }
            } else if (lastNotifiedCount !== loadedQuestionCount.value) {
              // 已全部加载完，且未提示过
              notify.info('已全部加载完毕');
              lastNotifiedCount = loadedQuestionCount.value;
            }
          }
        }
        // 页面挂载后绑定滚动事件
        onMounted(() => {
          loadFromLocalStorage();
          loadConfig();
          setTimeout(() => lucide.createIcons(), 100);
          // 绑定滚动事件
          if (questionListContainer.value) {
            questionListContainer.value.addEventListener('scroll', handleQuestionListScroll);
          }
        });
        // 切换tab时重新绑定滚动事件（防止ref丢失）
        watch(currentTab, () => {
          if (currentTab.value === 'questions' && questionListContainer.value) {
            questionListContainer.value.addEventListener('scroll', handleQuestionListScroll);
          }
        });

        // 生命周期钩子
        onMounted(() => {
          loadFromLocalStorage();
          loadConfig();
          // 确保图标正确加载
          setTimeout(() => lucide.createIcons(), 100);
        });

        // 监听deleteSourceSubject的变化，如果为true，则自动设置deleteSourceAfterTransfer为true
        watch(deleteSourceSubject, (newValue) => {
          if (newValue === true) {
            deleteSourceAfterTransfer.value = true;
          }
        });

        // 配置相关方法
        const saveConfig = () => {
          // 保存到本地存储
          localStorage.setItem('smartQuizApp_config', JSON.stringify(config.value));
          notify.success('配置已保存');
          showConfigModal.value = false;
        };

        // 测试提示词
        const testPrompt = async () => {
          if (!testPromptInput.value || isTestingPrompt.value) return;

          isTestingPrompt.value = true;
          testPromptResult.value = null;

          try {
            // 准备参数和提示词
            let prompt = config.value.answerPrompt.replace('{{title}}', testPromptInput.value);
            if (prompt.indexOf(testPromptInput.value) === -1) {
              prompt += "\n" + testPromptInput.value
            }

            // 准备参数
            const parameters = {
              input: prompt,
              model: selectedModel.value,
              action: "generate_answer"
            };

            // 调用Coze工作流API
            const result = await callCozeWorkflow(token, parameters);
            console.log("测试提示词API响应:", result);

            try {
              const data_json = JSON.parse(result.data);
              if (data_json && data_json.output) {
                testPromptResult.value = data_json.output;
              } else {
                // 模拟生成的答案
                testPromptResult.value = "这是测试生成的答案，基于题目内容自动生成。";
              }
            } catch (error) {
              console.error('解析API响应失败:', error);
              // 使用备用数据
              testPromptResult.value = "这是测试生成的答案，基于题目内容自动生成。";
            }
          } catch (error) {
            console.error('测试提示词失败:', error);
            notify.error('测试提示词失败，请稍后重试');
            // 使用备用数据
            testPromptResult.value = "这是测试生成的答案，基于题目内容自动生成。";
          } finally {
            isTestingPrompt.value = false;
          }
        };

        // 加载配置
        const loadConfig = () => {
          const storedConfig = localStorage.getItem('smartQuizApp_config');
          if (storedConfig) {
            try {
              const parsedConfig = JSON.parse(storedConfig);
              config.value = {
                ...config.value,
                ...parsedConfig
              };
            } catch (error) {
              console.error('解析配置失败:', error);
            }
          }
        };

        // 字体大小调整相关方法
        const startIncreaseFontSize = () => {
          // 先立即执行一次
          detailFontSize.value += 1;
          // 然后设置定时器持续执行
          fontSizeInterval = setInterval(() => {
            detailFontSize.value += 1;
            // 设置上限，防止字体过大
            if (detailFontSize.value > 48) {
              detailFontSize.value = 48;
              stopFontSizeChange();
            }
          }, 100);
        };

        const startDecreaseFontSize = () => {
          // 先立即执行一次
          detailFontSize.value -= 1;
          // 然后设置定时器持续执行
          fontSizeInterval = setInterval(() => {
            detailFontSize.value -= 1;
            // 设置下限，防止字体过小
            if (detailFontSize.value < 8) {
              detailFontSize.value = 8;
              stopFontSizeChange();
            }
          }, 100);
        };

        const stopFontSizeChange = () => {
          if (fontSizeInterval) {
            clearInterval(fontSizeInterval);
            fontSizeInterval = null;
          }
        };

        // 导出数据为JSON
        const exportData = () => {
          try {
            // 准备导出的数据
            const exportData = {
              subjects: subjects.value,
              questions: questions.value,
              version: '1.0'
            };

            // 转换为JSON字符串
            const jsonData = JSON.stringify(exportData, null, 2);

            // 创建Blob对象
            const blob = new Blob([jsonData], { type: 'application/json' });

            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `智能题库_${new Date().toISOString().split('T')[0]}.json`;

            // 触发下载
            document.body.appendChild(a);
            a.click();

            // 清理
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 0);

            notify.success('数据导出成功');
          } catch (error) {
            console.error('导出数据失败:', error);
            notify.error('导出数据失败，请稍后重试');
          }
        };

        // 导入JSON数据
        const importData = () => {
          try {
            // 检查是否有数据可导入
            if (importMethod.value === 'text' && !importDataText.value.trim()) {
              notify.warning('请输入要导入的JSON数据');
              return;
            }

            if (importMethod.value === 'file' && !selectedFileName.value) {
              notify.warning('请选择要导入的JSON文件');
              return;
            }

            // 确保文件内容已经读取
            if (importMethod.value === 'file' && !importDataText.value.trim()) {
              notify.warning('文件内容读取中，请稍候再试');
              return;
            }

            console.log('准备导入数据，数据长度:', importDataText.value.length);

            // 解析JSON数据
            const data = JSON.parse(importDataText.value);

            // 验证数据格式
            if (!data.subjects || !Array.isArray(data.subjects) || !data.questions || !Array.isArray(data.questions)) {
              notify.error('数据格式不正确，请检查后重试');
              return;
            }

            // 修改确认消息
            const confirmMessage = `确定要导入${data.subjects.length}个科目和${data.questions.length}道题目吗？导入时将保留现有题目，新题目将被添加到列表中。`;

            notify.confirm(
              confirmMessage,
              () => {
                // 用户确认，执行导入但不覆盖

                // 处理科目
                const newSubjects = [];
                const renamedSubjectsMap = new Map(); // 用于跟踪重命名的科目

                data.subjects.forEach(subject => {
                  if (!subjects.value.includes(subject)) {
                    // 如果科目不存在，直接添加
                    newSubjects.push(subject);
                  } else {
                    // 如果科目已存在，添加随机后缀
                    const randomNumber = Math.floor(Math.random() * 10000);
                    const newSubjectName = `${subject}(导入 ${randomNumber})`;
                    newSubjects.push(newSubjectName);
                    // 记录原科目名称到新科目名称的映射
                    renamedSubjectsMap.set(subject, newSubjectName);
                  }
                });

                // 添加新科目
                subjects.value = [...subjects.value, ...newSubjects];

                // 处理题目
                const newQuestions = [];
                data.questions.forEach(question => {
                  // 创建题目的副本
                  const questionCopy = { ...question };

                  // 检查科目是否被重命名
                  if (renamedSubjectsMap.has(question.subjects_name)) {
                    // 如果科目被重命名，更新题目的科目名称
                    questionCopy.subjects_name = renamedSubjectsMap.get(question.subjects_name);
                  }

                  // 确保题目有answers数组
                  if (!questionCopy.answers) {
                    questionCopy.answers = [];
                  }

                  newQuestions.push(questionCopy);
                });

                // 添加新题目到现有列表
                questions.value = [...questions.value, ...newQuestions];

                // 保存到本地存储
                saveToLocalStorage();

                // 关闭弹窗并重置输入
                showImportModal.value = false;
                importDataText.value = '';
                selectedFileName.value = '';
                if (importFileInput.value) {
                  importFileInput.value.value = '';
                }

                notify.success(`成功导入${newSubjects.length}个科目和${newQuestions.length}道题目`);

                // 重新初始化图标
                setTimeout(() => lucide.createIcons(), 100);
              },
              () => {
                // 用户取消，不执行任何操作
              },
              '确认导入'
            );
          } catch (error) {
            console.error('导入数据失败:', error);
            notify.error('导入数据失败，请检查JSON格式是否正确');
          }
        };

        // 处理文件导入
        const handleFileImport = (event) => {
          try {
            const file = event.target.files[0];
            if (file) {
              // 检查文件大小（限制为10MB）
              if (file.size > 10 * 1024 * 1024) {
                notify.error('文件大小不能超过10MB');
                if (importFileInput.value) {
                  importFileInput.value.value = '';
                }
                selectedFileName.value = '';
                return;
              }

              // 检查文件类型
              if (!file.type.startsWith('application/json') && !file.name.toLowerCase().endsWith('.json')) {
                notify.error('请上传JSON文件');
                if (importFileInput.value) {
                  importFileInput.value.value = '';
                }
                selectedFileName.value = '';
                return;
              }

              selectedFileName.value = file.name;
              console.log('已选择文件:', selectedFileName.value);

              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  // 将文件转换为JSON格式
                  importDataText.value = e.target.result;
                  console.log('文件内容已读取，长度:', importDataText.value.length);

                  // 尝试解析JSON，验证格式
                  const testParse = JSON.parse(importDataText.value);
                  if (!testParse || typeof testParse !== 'object') {
                    throw new Error('JSON格式无效');
                  }

                  // 提示用户文件已成功读取
                  notify.success(`文件 "${file.name}" 已成功读取，可以点击"确认导入"继续`);
                } catch (parseError) {
                  console.error('JSON解析失败:', parseError);
                  notify.error('文件内容不是有效的JSON格式，请检查文件内容');
                  importDataText.value = '';
                  selectedFileName.value = '';
                }
              };
              reader.onerror = (e) => {
                console.error('文件读取失败:', e);
                notify.error('文件读取失败，请重试');
                selectedFileName.value = '';
                importDataText.value = '';
              };

              // 添加额外的错误处理
              reader.onabort = () => {
                console.warn('文件读取被中断');
                notify.warning('文件读取被中断，请重试');
                selectedFileName.value = '';
              };

              // 读取文件内容
              reader.readAsText(file);
            }
          } catch (error) {
            console.error('处理文件导入时发生错误:', error);
            notify.error('文件选择过程中出现错误，请尝试使用文本导入方式');
            // 自动切换到文本导入
            importMethod.value = 'text';
          }
        };

        // 触发文件选择对话框
        const triggerFileInput = () => {
          if (importFileInput.value) {
            // 尝试使用label for属性方式自动触发
            const fileInput = document.getElementById('json-file-upload');
            if (fileInput) {
              fileInput.click();
            } else {
              // 回退到直接调用click方法
              importFileInput.value.click();
            }
          } else {
            console.error('文件输入引用未设置');
            notify.error('无法打开文件选择对话框，请刷新页面重试');
          }
        };

        // 处理粘贴事件
        const handlePaste = (event) => {
          try {
            // 这里只是提供一个反馈，实际内容由v-model处理
            setTimeout(() => {
              // 检查粘贴后的内容是否是有效的JSON
              try {
                if (importDataText.value && importDataText.value.trim()) {
                  const testParse = JSON.parse(importDataText.value);
                  if (testParse && typeof testParse === 'object') {
                    notify.success('JSON格式有效，可以点击"确认导入"继续');
                  }
                }
              } catch (error) {
                console.error('粘贴的内容不是有效的JSON:', error);
                notify.warning('粘贴的内容可能不是有效的JSON格式，请检查');
              }
            }, 100);
          } catch (error) {
            console.error('处理粘贴事件时出错:', error);
          }
        };

        // 本地解析文本
        const processLocalText = () => {
          if (!textInput.value || !selectedSubjectForUpload.value) {
            return;
          }

          try {
            // 调用parserText函数解析文本
            const parsedQuestions = parserText(textInput.value);

            // 处理科目名称：如果科目已存在，添加随机后缀；如果不存在，直接使用
            let subjects_name = selectedSubjectForUpload.value;
            if (subjects.value.includes(subjects_name)) {
              // 如果科目已存在，添加随机后缀
              const randomNumber = Math.floor(Math.random() * 10000);
              subjects_name = `${subjects_name}(本地解析 ${randomNumber})`;
            }

            // 处理解析结果
            if (parsedQuestions && Array.isArray(parsedQuestions) && parsedQuestions.length > 0) {
              // 为每个解析出的题目添加科目名称
              const processedQuestions = parsedQuestions.map(q => ({
                ...q,
                subjects_name: subjects_name,
                answers: [] // 初始化空的 answers 数组
              }));

              // 题目去重处理
              const existingTitles = new Set(questions.value.map(q => q.title.trim()));
              const uniqueQuestions = processedQuestions.filter(q => !existingTitles.has(q.title.trim()));

              // 如果有重复题目，显示提示
              const duplicateCount = processedQuestions.length - uniqueQuestions.length;
              if (duplicateCount > 0) {
                notify.warning(`已过滤 ${duplicateCount} 道重复题目`);
              }

              // 添加到题目列表
              questions.value.push(...uniqueQuestions);

              // 如果科目不在列表中，添加到科目列表
              if (!subjects.value.includes(subjects_name)) {
                subjects.value.push(subjects_name);
              }

              // 保存到本地存储
              saveToLocalStorage();

              // 清空输入
              textInput.value = '';
              selectedSubjectForUpload.value = '';

              // 跳转到题目页面
              currentTab.value = 'questions';
              // 设置筛选器为当前上传的科目
              selectedSubjectFilter.value = subjects_name;

              // 显示成功提示
              notify.success(`已成功解析并添加 ${uniqueQuestions.length} 道题目`);

              // 重新初始化图标
              setTimeout(() => lucide.createIcons(), 100);
            } else {
              notify.error('未能解析出题目数据，请检查输入内容');
            }
          } catch (error) {
            console.error('本地解析失败:', error);
            notify.error('本地解析失败: ' + error.message);
          }
        };

        // parserText函数，可由用户自行实现或使用默认实现
        const parserText = (text) => {
          // 检查是否存在用户自定义的解析工具
          if (typeof ptTool !== 'undefined' && ptTool.parseQuestions) {
            return ptTool.parseQuestions(text, selectedSubjectForUpload.value);
          }

          // 如果没有找到用户自定义的解析工具，显示警告并使用默认实现
          console.warn("未找到自定义的parseQuestions方法，将使用默认实现。您可以通过实现ParseTextTools类并替换ptTool实例来自定义解析逻辑。");

          /**
           * 默认解析函数实现
           * 
           * 此函数接收文本输入，并返回符合以下格式的数组：
           * [
           *   {
           *     classification: '题目类型，如"选择题"、"填空题"等',
           *     title: '题目内容',
           *     answer: '答案内容'
           *   },
           *   ...
           * ]
           */

          try {
            // 示例实现：将文本按空行分割为题目和答案对
            const pairs = text.split(/\n\s*\n/);
            const result = [];

            for (let i = 0; i < pairs.length; i++) {
              const pair = pairs[i].trim();
              if (!pair) continue;

              // 尝试找出题目和答案的分界线
              // 这里简单假设"答案："或"解析："标记答案的开始
              const answerIndex = pair.search(/(?:答案[：:：]|解析[：:：])/i);

              if (answerIndex > 0) {
                const title = pair.substring(0, answerIndex).trim();
                const answer = pair.substring(answerIndex).trim();

                // 推断题目类型
                let classification = '其他';
                if (title.includes('选择题') || /[A-D][.．。)]/.test(title)) {
                  classification = '选择题';
                } else if (title.includes('填空题') || title.includes('____')) {
                  classification = '填空题';
                } else if (title.includes('计算题') || title.includes('计算')) {
                  classification = '计算题';
                } else if (title.includes('问答题') || title.includes('简答题')) {
                  classification = '问答题';
                }

                result.push({
                  classification,
                  title,
                  answer
                });
              } else {
                // 如果没找到明确的分界线，假设这是一个没有答案的题目
                result.push({
                  classification: '其他',
                  title: pair,
                  answer: '暂无答案'
                });
              }
            }

            return result;
          } catch (e) {
            console.error('解析文本失败:', e);
            throw new Error('解析文本失败: ' + e.message);
          }
        };

        return {
          currentTab,
          subjects,
          questions,
          searchQuery,
          selectedCategory,
          fontSize,
          showAddSubjectModal,
          newSubjectsText,
          uploadedImage,
          textInput,
          selectedSubjectForUpload,
          isProcessing,
          selectedSubjectFilter,
          fileInput,
          uploadMode,
          categories,
          filteredQuestions,
          todayQuestions,
          addSubjects,
          selectSubject,
          getSubjectQuestionCount,
          clearSubjectFilter,
          handleFileUpload,
          clearUploadedImage,
          processUpload,
          confirmDeleteSubject,
          confirmDeleteQuestion,
          selectedModel,
          showTransferSubjectModal,
          targetSubject,
          sourceSubject,
          availableTargetSubjects,
          showTransferModal,
          transferQuestions,
          deleteSourceAfterTransfer,
          deleteSourceSubject,
          notifications,
          addNotification,
          removeNotification,
          getProgressColor,
          notify,
          // 题目详情相关
          showQuestionDetailModal,
          currentDetailQuestion,
          showQuestionDetail,
          generatedAnswers,
          isGeneratingAnswers,
          generateMoreAnswers,
          useGeneratedAnswer,
          detailFontSize,
          deleteGeneratedAnswer,
          loadGeneratedAnswers,
          updateQuestionWithAnswers,
          startIncreaseFontSize,
          startDecreaseFontSize,
          stopFontSizeChange,
          // 添加题目相关
          showAddQuestionModal,
          newQuestion,
          isGeneratingAnswer,
          generateAnswer,
          addQuestion,
          // 配置相关
          showConfigModal,
          config,
          saveConfig,
          testPromptInput,
          testPromptResult,
          isTestingPrompt,
          testPrompt,
          showCustomPromptModal,
          customPrompt,
          processedCustomPrompt,
          generateAnswerWithCustomPrompt,
          exportData,
          importData,
          showImportModal,
          importDataText,
          importMethod,
          importFileInput,
          selectedFileName,
          handleFileImport,
          triggerFileInput,
          handlePaste,
          processLocalText,
          questionListContainer,
          pagedQuestions,
          // 懒加载分页相关
          isLoadingMore,
          isAllLoaded
        };
      }
    };

    // 创建应用并挂载
    createApp(App).mount('#app');
  </script>
</body>

</html>